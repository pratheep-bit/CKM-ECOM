<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karungali Heritage - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #F2F6EF 0%, #F3E9DC 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #765341;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stat-card h3 {
            color: #9A6A51;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            color: #765341;
            font-size: 32px;
            font-weight: 700;
        }
        
        .orders-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            color: #765341;
            font-size: 22px;
            font-weight: 600;
        }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 8px 16px;
            border: 2px solid #F3E9DC;
            background: white;
            color: #765341;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab:hover {
            border-color: #9A6A51;
        }
        
        .tab.active {
            background: #765341;
            color: white;
            border-color: #765341;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }
        
        .orders-table thead {
            background: #F3E9DC;
        }
        
        .orders-table th {
            padding: 12px;
            text-align: left;
            color: #765341;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        .orders-table tbody {
            display: table;
            width: 100%;
        }
        
        .orders-table tr {
            border-bottom: 1px solid #F3E9DC;
        }
        
        .orders-table td {
            padding: 16px 12px;
            color: #5C4033;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #FFF3CD;
            color: #856404;
        }
        
        .status-confirmed {
            background: #D1ECF1;
            color: #0C5460;
        }
        
        .status-shipped {
            background: #D4EDDA;
            color: #155724;
        }
        
        .status-delivered {
            background: #D4EDDA;
            color: #155724;
        }
        
        .status-cancelled {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #765341;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5C4033;
        }
        
        .btn-secondary {
            background: #F3E9DC;
            color: #765341;
        }
        
        .btn-secondary:hover {
            background: #E5D5C4;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #9A6A51;
        }
        
        .empty {
            text-align: center;
            padding: 60px;
            color: #9A6A51;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #765341;
            font-size: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            color: #765341;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #F3E9DC;
            border-radius: 6px;
            font-family: inherit;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .refresh-btn {
            background: #F3E9DC;
            color: #765341;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            background: #E5D5C4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõçÔ∏è Karungali Heritage - Admin Panel</h1>
            <p style="color: #9A6A51; margin-top: 5px;">Manage your orders and track sales</p>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Total Orders</h3>
                <div class="value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <h3>Pending</h3>
                <div class="value" id="pendingOrders">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="value" id="totalRevenue">‚Çπ0</div>
            </div>
        </div>
        
        <div class="orders-section">
            <div class="section-header">
                <h2>Orders</h2>
                <button class="refresh-btn" onclick="loadOrders()">üîÑ Refresh</button>
            </div>
            
            <div class="filter-tabs">
                <div class="tab active" data-filter="all" onclick="filterOrders('all')">All</div>
                <div class="tab" data-filter="pending" onclick="filterOrders('pending')">Pending</div>
                <div class="tab" data-filter="confirmed" onclick="filterOrders('confirmed')">Confirmed</div>
                <div class="tab" data-filter="shipped" onclick="filterOrders('shipped')">Shipped</div>
                <div class="tab" data-filter="delivered" onclick="filterOrders('delivered')">Delivered</div>
                <div class="tab" data-filter="cancelled" onclick="filterOrders('cancelled')">Cancelled</div>
            </div>
            
            <div id="ordersContainer">
                <div class="loading">Loading orders...</div>
            </div>
        </div>
    </div>
    
    <!-- Update Status Modal -->
    <div class="modal" id="updateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Order Status</h3>
            </div>
            <form id="updateForm">
                <div class="form-group">
                    <label>Order Number</label>
                    <input type="text" id="modalOrderNumber" readonly style="background: #F3E9DC; padding: 10px; border-radius: 6px; border: none; width: 100%;">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="modalStatus" required>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Admin Notes (Optional)</label>
                    <textarea id="modalNotes" placeholder="Add notes about this order..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000';
        const ADMIN_KEY = 'admin123';
        let allOrders = [];
        let currentFilter = 'all';
        
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/api/v1/guest-orders?admin_key=${ADMIN_KEY}`);
                if (!response.ok) throw new Error('Failed to fetch orders');
                
                allOrders = await response.json();
                updateStats();
                renderOrders();
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="empty">
                        ‚ùå Failed to load orders. Make sure the API server is running on port 8000.
                    </div>
                `;
            }
        }
        
        function updateStats() {
            const total = allOrders.length;
            const pending = allOrders.filter(o => o.status === 'pending').length;
            const revenue = allOrders.reduce((sum, o) => sum + o.total_amount, 0);
            
            document.getElementById('totalOrders').textContent = total;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('totalRevenue').textContent = `‚Çπ${revenue.toLocaleString()}`;
        }
        
        function filterOrders(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            renderOrders();
        }
        
        function renderOrders() {
            const filtered = currentFilter === 'all' 
                ? allOrders 
                : allOrders.filter(o => o.status === currentFilter);
            
            if (filtered.length === 0) {
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="empty">No orders found.</div>
                `;
                return;
            }
            
            const html = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>Location</th>
                            <th>Qty</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(order => `
                            <tr>
                                <td><strong>${order.order_number}</strong></td>
                                <td>${order.customer_name}</td>
                                <td>${order.customer_phone}</td>
                                <td>${order.city}, ${order.state}</td>
                                <td>${order.quantity}</td>
                                <td><strong>‚Çπ${order.total_amount.toLocaleString()}</strong></td>
                                <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick='openUpdateModal(${JSON.stringify(order)})'>
                                        Update
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('ordersContainer').innerHTML = html;
        }
        
        function openUpdateModal(order) {
            document.getElementById('modalOrderNumber').value = order.order_number;
            document.getElementById('modalStatus').value = order.status;
            document.getElementById('modalNotes').value = order.admin_notes || '';
            document.getElementById('updateModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('updateModal').classList.remove('active');
        }
        
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderNumber = document.getElementById('modalOrderNumber').value;
            const status = document.getElementById('modalStatus').value;
            const notes = document.getElementById('modalNotes').value;
            
            try {
                const response = await fetch(
                    `${API_URL}/api/v1/guest-orders/${orderNumber}/status?admin_key=${ADMIN_KEY}`,
                    {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status, admin_notes: notes || null })
                    }
                );
                
                if (!response.ok) throw new Error('Failed to update order');
                
                alert('‚úÖ Order status updated successfully!');
                closeModal();
                loadOrders();
            } catch (error) {
                alert('‚ùå Failed to update order: ' + error.message);
            }
        });

        // Close modal when clicking outside
        document.getElementById('updateModal').addEventListener('click', (e) => {
            if (e.target.id === 'updateModal') closeModal();
        });
        
        // Load orders on page load
        loadOrders();
        
        // Auto-refresh every 30 seconds
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>
